<html lang="en">
  <head>
    <style>
      .rits { color: black; font-size: 20;}
      .student { color: blue; font-weight: bold; font-size: 20; padding-left: 5%}
    </style>
      
      <script src="/jquery-2.0.3.min.js"></script>
      <script src="/pengines.js"></script>
      <script type="text/x-prolog">

            main :-
                rits:rits_start(S0),
                rits:rits_next_action(solve(1/2+3/4),A,S0,S1),
                interact(A, S1).

            interact(A, S) :-
                (    interact_(A, S) -> true
                ;    term_to_atom(A, Atom),
                     pengine_output(Atom)
                ).

            
            interact_(format(F,Args), S0) :-
                pengine_output(format(F, Args)),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(format(F), S0) :-
                pengine_output(format(F, [])),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(fraction_layout(F), S0) :-
                phrase(mathml(F), Ms),
                atom_codes(Action, Ms),
                pengine_output(Action),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(read_answer, S0) :-
                pengine_input('Please answer: ', Input),
                (    Input == stop -> true
                ;    rits:rits_next_action(student_answers(Input), A, S0, S),
                     interact(A, S)
                ).
            interact_(enter, S0) :-
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(exit, S0) :-
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(solve(T), S0) :-
                rits:rits_next_action(solve(T), A, S0, S),
                interact(A, S).

            mathml(M) --> "<br><math style=\"padding-left: 5%\">", mathml_(M), "</math>".

            mathml_(I) --> { integer(I) }, !, "<mi style=\"font-size: 20; font-weight: bold;\">", format_(I), "</mi>".
            mathml_(A/B) --> !, "<mfrac>", mathml_(A), mathml_(B), "</mfrac>".
            mathml_(A+B) -->
                    "<mrow>", mathml_(A), "</mrow>",
                    "<mo>+</mo>",
                    "<mrow>", mathml_(B), "</mrow>".

            format_(Arg) --> call(format_dcg(Arg)).

            format_dcg(Arg, Cs0, Cs) :- format(codes(Cs0,Cs), "~w", [Arg]).
      </script>
      <script>
            var pengine = new Pengine({
                oncreate: handleCreate,
                // onprompt: handlePrompt,
                onoutput: handleOutput
            });
            function handleCreate() {
                pengine.ask('main');
            }
            function handlePrompt() {
                //pengine.respond(prompt(this.data));
            }
            function handleOutput() {
                var d = this.data;
                var str = d;
                // console.log(d);
                if (d.functor == "format" && d.args.length == 2) {
                    str = d.args[0].functor;
                    d.args[1].forEach(function (a) {
                         str = str.replace("~w", a);
                    });
                    str = str.replace("~t", "").replace("~10+", "");
                }
                if (str == "done") { str = "<br><span style=\"color: green\">Done.</span>"; }
                $('#out').append("<div class=\"rits\">" + str + "</div>");
                window.scrollTo(0,document.body.scrollHeight);
            }
      </script>
  </head>
  <body style="padding-left: 5%; padding-right: 5%">
    <br><br>
    <div id="out"></div>
    <br>
    <hr style="width:10cm; margin-left: 0pt;">
    <form>
      Your answer:<br>
      <input type="text" id="studentInput">
    </form>
    <div style="display: none; position: absolute; right: 20%; font-size: 15"><a style="text-decoration: none; color:#0000ff;" href="http://github.com/triska/rits">Contribute</a></div>
  </body>
  <script>
    console.log("loaded!");
    //console.log(typeof($('#studentInput')));
    $("#studentInput").focus(function () { console.log("focus"); });
    $("#studentInput").keydown(function (ev) {
        if (ev.keyCode == 13) {

            var r = this.value.replace(".", "");
            $('#out').append("<br><div class=\"student\">" + r + "</div><br>");
            this.value = '';
            ev.preventDefault();
            pengine.respond(r);
        }
    });
    $("#studentInput").focus();
  </script>
</html>
