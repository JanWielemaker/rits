<html lang="en">
  <head>
    <style>
      .rits { color: black; font-size: 20;}
      .student { color: blue; font-weight: bold; font-size: 20; padding-left: 5%}
    </style>
      
      <script src="/jquery-2.0.3.min.js"></script>
      <script src="/pengines.js"></script>
      <script type="text/x-prolog">

            main :-
                rits:rits_start(S0),
                rits:rits_next_action(solve(1/2+3/4),A,S0,S1),
                interact(A, S1).

            interact(A, S) :-
                (    interact_(A, S) -> true
                ;    term_to_atom(A, Atom),
                     pengine_output(Atom)
                ).

            
            interact_(format(F,Args), S0) :-
                (    poutput(F, Args) -> true
                ;    term_to_atom(F-Args, Action),
                     pengine_output(Action)
                ),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(format(F), S0) :-
                (    poutput(F) -> true
                ;    atom_string(Atom, F),
                     pengine_output(Atom)
                ),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(fraction_layout(F), S0) :-
                phrase(mathml(F), Ms),
                atom_codes(Action, Ms),
                pengine_output(Action),
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(read_answer, S0) :-
                pengine_input('Please answer: ', Input),
                (    Input == stop -> true
                ;    rits:rits_next_action(student_answers(Input), A, S0, S),
                     interact(A, S)
                ).
            interact_(enter, S0) :-
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(exit, S0) :-
                rits:rits_next_action(next, A, S0, S),
                interact(A, S).
            interact_(solve(T), S0) :-
                rits:rits_next_action(solve(T), A, S0, S),
                interact(A, S).

            mathml(M) --> "<br><math style=\"padding-left: 5%\">", mathml_(M), "</math>".

            mathml_(I) --> { integer(I) }, !, "<mi style=\"font-size: 20; font-weight: bold;\">", format_(I), "</mi>".
            mathml_(A/B) --> !, "<mfrac>", mathml_(A), mathml_(B), "</mfrac>".
            mathml_(A+B) -->
                    "<mrow>", mathml_(A), "</mrow>",
                    "<mo>+</mo>",
                    "<mrow>", mathml_(B), "</mrow>".

            format_(Arg) --> call(format_dcg(Arg)).

            format_dcg(Arg, Cs0, Cs) :- format(codes(Cs0,Cs), "~w", [Arg]).

poutput("Let us first find a common multiple of ~w and ~w!\n", [B,D]) :-
                           format(atom(C),
                           "Let us first find a common multiple of ~w and ~w!\n",
                           [B,D]),
                           pengine_output(C).


% Generated code follows.
poutput("Please enter a common multiple of ~w and ~w:\n\n", [A, B]) :-
	format(atom(C),
	       "Please enter a common multiple of ~w and ~w:\n\n",
	       [A, B]),
	pengine_output(C).
poutput("A common multiple must be an integer!\n") :-
	format(atom(A), "A common multiple must be an integer!\n", []),
	pengine_output(A).
poutput("The solution must be greater than 0.\n") :-
	format(atom(A), "The solution must be greater than 0.\n", []),
	pengine_output(A).
poutput("Good, the solution is correct") :-
	format(atom(A), "Good, the solution is correct", []),
	pengine_output(A).
poutput(" and also minimal. Very nice!\n\n") :-
	format(atom(A), " and also minimal. Very nice!\n\n", []),
	pengine_output(A).
poutput(". There is also a smaller solution!\n") :-
	format(atom(A), ". There is also a smaller solution!\n", []),
	pengine_output(A).
poutput("I see you are having a hard time with this.\n") :-
	format(atom(A), "I see you are having a hard time with this.\n", []),
	pengine_output(A).
poutput("Hint: ~w * ~w = ~w is a possible solution.\n", [A, B, C]) :-
	format(atom(D),
	       "Hint: ~w * ~w = ~w is a possible solution.\n",
	       [A, B, C]),
	pengine_output(D).
poutput("~w is not a common multiple of ~w and ~w, since ~w is not divisible by ~w!\n", [A, B, C, A, B]) :-
	format(atom(D),
	       "~w is not a common multiple of ~w and ~w, since ~w is not divisible by ~w!\n",
	       [A, B, C, A, B]),
	pengine_output(D).
poutput("~w is no common multiple of ~w and ~w, since ~w is not divisible by ~w!\n", [A, C, B, A, B]) :-
	format(atom(D),
	       "~w is no common multiple of ~w and ~w, since ~w is not divisible by ~w!\n",
	       [A, C, B, A, B]),
	pengine_output(D).
poutput("Please solve:\n\n~t~10+") :-
	format(atom(A), "Please solve:\n\n~t~10+", []),
	pengine_output(A).
poutput("Please simplify the fraction:\n\n~t~10+") :-
	format(atom(A), "Please simplify the fraction:\n\n~t~10+", []),
	pengine_output(A).
poutput("The denominator of a fraction cannot be 0.\n") :-
	format(atom(A), "The denominator of a fraction cannot be 0.\n", []),
	pengine_output(A).
poutput("Good, the solution is correct") :-
	format(atom(A), "Good, the solution is correct", []),
	pengine_output(A).
poutput(" and also minimal. Very nice!\n\n") :-
	format(atom(A), " and also minimal. Very nice!\n\n", []),
	pengine_output(A).
poutput(", but not minimal.\n") :-
	format(atom(A), ", but not minimal.\n", []),
	pengine_output(A).
poutput("Good, the solution is correct and also minimal. Very nice!\n\n") :-
	format(atom(A),
	       "Good, the solution is correct and also minimal. Very nice!\n\n",
	       []),
	pengine_output(A).
poutput("The answer must be an integer or a fraction.\n") :-
	format(atom(A), "The answer must be an integer or a fraction.\n", []),
	pengine_output(A).
poutput("Good, the solution is correct") :-
	format(atom(A), "Good, the solution is correct", []),
	pengine_output(A).
poutput(" and also minimal. Very nice!\n\n") :-
	format(atom(A), " and also minimal. Very nice!\n\n", []),
	pengine_output(A).
poutput(", but not minimal.\n") :-
	format(atom(A), ", but not minimal.\n", []),
	pengine_output(A).
poutput("The answer must be an integer or a fraction.\n") :-
	format(atom(A), "The answer must be an integer or a fraction.\n", []),
	pengine_output(A).
poutput("I see you are having a hard time with this.\n") :-
	format(atom(A), "I see you are having a hard time with this.\n", []),
	pengine_output(A).
poutput("Hint: Write this fraction as a single integer.\n") :-
	format(atom(A),
	       "Hint: Write this fraction as a single integer.\n",
	       []),
	pengine_output(A).
poutput("Hint: Find a common divisor of ~w and ~w.\n", [A, B]) :-
	format(atom(C),
	       "Hint: Find a common divisor of ~w and ~w.\n",
	       [A, B]),
	pengine_output(C).
poutput("Do not just guess! Multiply correctly, then add!\n") :-
	format(atom(A),
	       "Do not just guess! Multiply correctly, then add!\n",
	       []),
	pengine_output(A).
poutput("The denominator is suitable, but the numerator is wrong!\n") :-
	format(atom(A),
	       "The denominator is suitable, but the numerator is wrong!\n",
	       []),
	pengine_output(A).
poutput("The denominator is suitable, but the numerator is wrong!\n") :-
	format(atom(A),
	       "The denominator is suitable, but the numerator is wrong!\n",
	       []),
	pengine_output(A).
poutput("Use a smaller common multiple as denominator to make this easier.\n") :-
	format(atom(A),
	       "Use a smaller common multiple as denominator to make this easier.\n",
	       []),
	pengine_output(A).
poutput("You cannot just sum the numerators when the denominators are different!\n\n") :-
	format(atom(A),
	       "You cannot just sum the numerators when the denominators are different!\n\n",
	       []),
	pengine_output(A).
poutput("Recall that you have already found the least common multiple of ~w and ~w!\n", [A, B]) :-
	format(atom(C),
	       "Recall that you have already found the least common multiple of ~w and ~w!\n",
	       [A, B]),
	pengine_output(C).
poutput("First rewrite the fractions so that the denominator is ~w for both, then add.\n", [A]) :-
	format(atom(B),
	       "First rewrite the fractions so that the denominator is ~w for both, then add.\n",
	       [A]),
	pengine_output(B).
poutput("Recall that you have already found a common multiple of ~w and ~w: ~w\n", [A, B, C]) :-
	format(atom(D),
	       "Recall that you have already found a common multiple of ~w and ~w: ~w\n",
	       [A, B, C]),
	pengine_output(D).
poutput("You can either use that, or find a smaller multiple to make it easier.\n") :-
	format(atom(A),
	       "You can either use that, or find a smaller multiple to make it easier.\n",
	       []),
	pengine_output(A).
poutput("You should not sum the denominators, but only the numerators!\n") :-
	format(atom(A),
	       "You should not sum the denominators, but only the numerators!\n",
	       []),
	pengine_output(A).
poutput("~w cannot be a common denominator, because it cannot be divided by ~w.\n", [A, B]) :-
	format(atom(C),
	       "~w cannot be a common denominator, because it cannot be divided by ~w.\n",
	       [A, B]),
	pengine_output(C).
poutput("~w cannot be a common denominator, because it cannot be divided by ~w.\n", [A, B]) :-
	format(atom(C),
	       "~w cannot be a common denominator, because it cannot be divided by ~w.\n",
	       [A, B]),
	pengine_output(C).

                           
      </script>
      <script>
            var pengine = new Pengine({
                oncreate: handleCreate,
                // onprompt: handlePrompt,
                onoutput: handleOutput
            });
            function handleCreate() {
                pengine.ask('main');
            }
            function handlePrompt() {
                //pengine.respond(prompt(this.data));
            }
            function handleOutput() {
                var d = this.data;
                // console.log(d);
                if (d == "done") { d = "<br><span style=\"color: green\">Done.</span>"; }
                $('#out').append("<div class=\"rits\">" + d + "</div>");
                window.scrollTo(0,document.body.scrollHeight);
            }
      </script>
  </head>
  <body style="padding-left: 5%; padding-right: 5%">
    <br><br>
    <div id="out"></div>
    <br>
    <hr style="width:10cm; margin-left: 0pt;">
    <form>
      Your answer:<br>
      <input type="text" id="studentInput">
    </form>
  </body>
  <script>
    console.log("loaded!");
    //console.log(typeof($('#studentInput')));
    $("#studentInput").focus(function () { console.log("focus"); });
    $("#studentInput").keydown(function (ev) {
        if (ev.keyCode == 13) {

            var r = this.value;
            $('#out').append("<br><div class=\"student\">" + r + "</div><br>");
            this.value = '';
            ev.preventDefault();
            pengine.respond(r);
        }
    });
    
  </script>
</html>
